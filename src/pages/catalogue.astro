---
import BaseLayout from "../layout/BaseLayout.astro";
import SearchBar from "../components/catalogue/SearchBar.astro";
import ProductGrid from "../components/catalogue/ProductGrid.astro";
---

<BaseLayout>
  <div class="max-w-7xl mx-auto px-6 py-12 md:py-24">
    <div class="mb-8">
      <h1 class="text-4xl font-black tracking-tight mb-3">Katalog Produk</h1>
      <p class="text-[#897961] text-lg max-w-2xl">
        Temukan kebutuhan bumbu dapur dan jajanan favorit Anda dengan harga
        terjangkau setiap hari.
      </p>
    </div>
    <SearchBar />
    <ProductGrid />
    <div class="flex justify-center mt-12 mb-8">
      <button
        id="loadMoreBtn"
        class="flex items-center gap-2 px-8 py-3 bg-primary-500 text-white rounded-xl font-bold hover:bg-primary transition-all shadow-sm"
      >
        Tampilkan Lebih Banyak
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="size-6"
        >
          <path
            fill-rule="evenodd"
            d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
</BaseLayout>

<script>
  // Konstanta untuk pagination
  const ITEMS_PER_PAGE = 8;

  // State untuk pagination
  let currentlyShowing = ITEMS_PER_PAGE;

  // Ambil semua elemen
  const productItems = document.querySelectorAll(".product-item");
  const loadMoreBtn = document.getElementById("loadMoreBtn");

  // Fungsi untuk cek apakah produk lolos filter
  function productMatchesFilter(productCard: HTMLElement) {
    const getCurrentFilter = (window as any).getCurrentFilter;
    if (!getCurrentFilter) return true;

    const { filter, search } = getCurrentFilter();
    const productName = productCard.dataset.name?.toLowerCase() || "";
    const productTag = productCard.dataset.tag?.toLowerCase() || "";

    const matchesSearch = productName.includes(search.toLowerCase());
    const matchesFilter = filter === "semua" || productTag === filter;

    return matchesSearch && matchesFilter;
  }

  // Fungsi untuk update tampilan produk
  function updateProductDisplay() {
    let visibleCount = 0;
    let filteredIndex = 0;

    productItems.forEach((item) => {
      const itemElement = item as HTMLElement;
      const productCard = itemElement.querySelector(
        ".product-card",
      ) as HTMLElement;

      if (!productCard) return;

      // Cek apakah produk lolos filter
      const matchesFilter = productMatchesFilter(productCard);

      if (matchesFilter) {
        // Produk lolos filter, cek apakah dalam range pagination
        if (filteredIndex < currentlyShowing) {
          itemElement.style.display = "block";
          productCard.style.display = "block";
          visibleCount++;
        } else {
          itemElement.style.display = "none";
        }
        filteredIndex++;
      } else {
        // Produk tidak lolos filter
        itemElement.style.display = "none";
        productCard.style.display = "none";
      }
    });

    // Update visibilitas tombol "Tampilkan Lebih Banyak"
    updateLoadMoreButton();

    return visibleCount;
  }

  // Fungsi untuk update tombol "Load More"
  function updateLoadMoreButton() {
    if (!loadMoreBtn) return;

    // Hitung berapa banyak item yang lolos filter
    let filteredCount = 0;
    productItems.forEach((item) => {
      const productCard = item.querySelector(".product-card") as HTMLElement;
      if (productCard && productMatchesFilter(productCard)) {
        filteredCount++;
      }
    });

    // Sembunyikan tombol jika sudah menampilkan semua item yang tersedia
    if (currentlyShowing >= filteredCount) {
      loadMoreBtn.style.display = "none";
    } else {
      loadMoreBtn.style.display = "flex";
    }
  }

  // Event listener untuk tombol "Load More"
  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", () => {
      currentlyShowing += ITEMS_PER_PAGE;
      updateProductDisplay();
    });
  }

  // Reset pagination ketika filter berubah
  function resetPagination() {
    currentlyShowing = ITEMS_PER_PAGE;
    updateProductDisplay();
  }

  // Expose fungsi untuk digunakan oleh komponen lain
  (window as any).resetPagination = resetPagination;
  (window as any).updateProductDisplay = updateProductDisplay;

  // Inisialisasi tampilan awal
  updateProductDisplay();
</script>
